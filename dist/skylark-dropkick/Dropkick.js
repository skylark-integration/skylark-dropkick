/**
 * skylark-dropkick - A version of dropkick that ported to running on skylarkjs ui.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-dropkick/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-jquery","./utils","./defaults"],function(e,t,s,i){const a=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),l=window.parent!==window.self;let d;class o{constructor(e,t){let i,a;this.sel=e;let l=window.Dropkick;for("string"==typeof this.sel&&"#"===this.sel[0]&&(this.sel=document.getElementById(e.substr(1))),i=0;i<l.uid;i++)if((a=l.cache[i])instanceof o&&a.data.select===this.sel)return s.extend(a.data.settings,t),a;if(!this.sel)throw"You must pass a select to DropKick";if(this.sel.length<1)throw`You must have options inside your <select>: ${e}`;if("SELECT"===this.sel.nodeName)return this.init(this.sel,t)}init(e,t){let n=window.Dropkick;var h,r=o.build(e,"dk"+n.uid);if(this.data={},this.data.select=e,this.data.elem=r.elem,this.data.settings=s.extend({},i,t),this.disabled=e.disabled,this.form=e.form,this.length=e.length,this.multiple=e.multiple,this.options=r.options.slice(0),this.selectedIndex=e.selectedIndex,this.selectedOptions=r.selected.slice(0),this.value=e.value,this.data.cacheID=n.uid,n.cache[this.data.cacheID]=this,this.data.settings.initialize.call(this),n.uid+=1,this._changeListener||(e.addEventListener("change",this),this._changeListener=!0),!a||this.data.settings.mobile){if(e.parentNode.insertBefore(this.data.elem,e),e.setAttribute("data-dkCacheId",this.data.cacheID),this.data.elem.addEventListener("click",this),this.data.elem.addEventListener("keydown",this),this.data.elem.addEventListener("keypress",this),this.form&&this.form.addEventListener("reset",this),!this.multiple)for(h=0;h<this.options.length;h++)this.options[h].addEventListener("mouseover",this);d||(document.addEventListener("click",o.onDocClick),l&&parent.document.addEventListener("click",o.onDocClick),d=!0)}return this}add(e,t){var i,a,l;"string"==typeof e&&(i=e,(e=document.createElement("option")).text=i),"OPTION"===e.nodeName&&(a=s.create("li",{class:"dk-option","data-value":e.value,text:e.text,innerHTML:e.innerHTML,role:"option","aria-selected":"false",id:"dk"+this.data.cacheID+"-"+(e.id||e.value.replace(" ","-"))}),s.addClass(a,e.className),this.length+=1,e.disabled&&(s.addClass(a,"dk-option-disabled"),a.setAttribute("aria-disabled","true")),e.hidden&&(s.addClass(a,"dk-option-hidden"),a.setAttribute("aria-hidden","true")),this.data.select.add(e,t),"number"==typeof t&&(t=this.item(t)),(l=this.options.indexOf(t))>-1?(t.parentNode.insertBefore(a,t),this.options.splice(l,0,a)):(this.data.elem.lastChild.appendChild(a),this.options.push(a)),a.addEventListener("mouseover",this),e.selected&&this.select(l))}item(e){return e=e<0?this.options.length+e:e,this.options[e]||null}remove(e){let t=this.item(e);t.parentNode.removeChild(t),this.options.splice(e,1),this.data.select.remove(e),this.select(this.data.select.selectedIndex),this.length-=1}close(){var e,t=this.data.elem;if(!this.isOpen||this.multiple)return!1;for(e=0;e<this.options.length;e++)s.removeClass(this.options[e],"dk-option-highlight");t.lastChild.setAttribute("aria-expanded","false"),s.removeClass(t.lastChild,"dk-select-options-highlight"),s.removeClass(t,"dk-select-open-(up|down)"),this.isOpen=!1,this.data.settings.close.call(this)}open(){let e,t,i,a,l,d,o=this.data.elem,n=o.lastChild,h=void 0!==window.pageXOffset,r="CSS1Compat"===(document.compatMode||""),c=h?window.pageYOffset:r?document.documentElement.scrollTop:document.body.scrollTop;if(l=s.offset(o).top-c,d=window.innerHeight-(l+o.offsetHeight),this.isOpen||this.multiple)return!1;n.style.display="block",e=n.offsetHeight,n.style.display="",a=(t=l>e)&&!(i=d>e)?"-up":"-down",this.isOpen=!0,s.addClass(o,"dk-select-open"+a),n.setAttribute("aria-expanded","true"),this._scrollTo(this.options.length-1),this._scrollTo(this.selectedIndex),this.data.settings.open.call(this)}disable(e,t){var i="dk-option-disabled";0!==arguments.length&&"boolean"!=typeof e||(t=void 0===e,e=this.data.elem,i="dk-select-disabled",this.disabled=t),void 0===t&&(t=!0),"number"==typeof e&&(e=this.item(e)),t?(e.setAttribute("aria-disabled",!0),s.addClass(e,i)):(e.setAttribute("aria-disabled",!1),s.removeClass(e,i))}hide(e,t){void 0===t&&(t=!0),e=this.item(e),t?(e.setAttribute("aria-hidden",!0),s.addClass(e,"dk-option-hidden")):(e.setAttribute("aria-hidden",!1),s.removeClass(e,"dk-option-hidden"))}select(e,t){var i,a,l,d,o=this.data.select;if("number"==typeof e&&(e=this.item(e)),"string"==typeof e)for(i=0;i<this.length;i++)this.options[i].getAttribute("data-value")===e&&(e=this.options[i]);return!(!e||"string"==typeof e||!t&&s.hasClass(e,"dk-option-disabled"))&&(s.hasClass(e,"dk-option")?(a=this.options.indexOf(e),l=o.options[a],this.multiple?(s.toggleClass(e,"dk-option-selected"),l.selected=!l.selected,s.hasClass(e,"dk-option-selected")?(e.setAttribute("aria-selected","true"),this.selectedOptions.push(e)):(e.setAttribute("aria-selected","false"),a=this.selectedOptions.indexOf(e),this.selectedOptions.splice(a,1))):(d=this.data.elem.firstChild,this.selectedOptions.length&&(s.removeClass(this.selectedOptions[0],"dk-option-selected"),this.selectedOptions[0].setAttribute("aria-selected","false")),s.addClass(e,"dk-option-selected"),e.setAttribute("aria-selected","true"),d.setAttribute("aria-activedescendant",e.id),d.className="dk-selected "+l.className,d.innerHTML=l.innerHTML,this.selectedOptions[0]=e,l.selected=!0),this.selectedIndex=o.selectedIndex,this.value=o.value,t||this.data.select.dispatchEvent(new CustomEvent("change",{bubbles:this.data.settings.bubble})),e):void 0)}selectOne(e,t){return this.reset(!0),this._scrollTo(e),this.select(e,t)}search(e,t){var s,i,a,l,d,o,n,h,r=this.data.select.options,c=[];if(!e)return this.options;for(t="fuzzy"===(t=t?t.toLowerCase():"strict")?2:"partial"===t?1:0,h=new RegExp((t?"":"^")+e,"i"),s=0;s<r.length;s++)if(a=r[s].text.toLowerCase(),2==t){for(i=e.toLowerCase().split(""),l=d=o=n=0;d<a.length;)a[d]===i[l]?(o+=1+o,l++):o=0,n+=o,d++;l===i.length&&c.push({e:this.options[s],s:n,i:s})}else h.test(a)&&c.push(this.options[s]);return 2===t&&(c=c.sort(function(e,t){return t.s-e.s||e.i-t.i}).reduce(function(e,t){return e[e.length]=t.e,e},[])),c}focus(){this.disabled||(this.multiple?this.data.elem:this.data.elem.children[0]).focus()}reset(e){var t,i=this.data.select;for(this.selectedOptions.length=0,t=0;t<i.options.length;t++)i.options[t].selected=!1,s.removeClass(this.options[t],"dk-option-selected"),this.options[t].setAttribute("aria-selected","false"),!e&&i.options[t].defaultSelected&&this.select(t,!0);this.selectedOptions.length||this.multiple||this.select(0,!0)}refresh(){Object.keys(this).length>0&&(!a||this.data.settings.mobile)&&this.dispose().init(this.data.select,this.data.settings)}dispose(){let e=window.Dropkick;return Object.keys(this).length>0&&(!a||this.data.settings.mobile)&&(delete e.cache[this.data.cacheID],this.data.elem.parentNode.removeChild(this.data.elem),this.data.select.removeAttribute("data-dkCacheId")),this}handleEvent(e){if(!this.disabled)switch(e.type){case"click":this._delegate(e);break;case"keydown":this._keyHandler(e);break;case"keypress":this._searchOptions(e);break;case"mouseover":this._highlight(e);break;case"reset":this.reset();break;case"change":this.data.settings.change.call(this)}}_delegate(e){var t,i,a,l,d=e.target;if(s.hasClass(d,"dk-option-disabled"))return!1;if(this.multiple){if(s.hasClass(d,"dk-option"))if("Range"===(t=window.getSelection()).type&&t.collapseToStart(),e.shiftKey)if(a=this.options.indexOf(this.selectedOptions[0]),l=this.options.indexOf(this.selectedOptions[this.selectedOptions.length-1]),(i=this.options.indexOf(d))>a&&i<l&&(i=a),i>l&&l>a&&(l=a),this.reset(!0),l>i)for(;i<l+1;)this.select(i++);else for(;i>l-1;)this.select(i--);else e.ctrlKey||e.metaKey?this.select(d):(this.reset(!0),this.select(d))}else this[this.isOpen?"close":"open"](),s.hasClass(d,"dk-option")&&this.select(d)}_highlight(e){var t,i=e.target;if(!this.multiple){for(t=0;t<this.options.length;t++)s.removeClass(this.options[t],"dk-option-highlight");s.addClass(this.data.elem.lastChild,"dk-select-options-highlight"),s.addClass(i,"dk-option-highlight")}}_keyHandler(e){var t,i,a=this.selectedOptions,l=this.options,d=1,o=9,n=13,h=27,r=32,c=38,p=40;switch(e.keyCode){case c:d=-1;case p:if(e.preventDefault(),t=a[a.length-1],s.hasClass(this.data.elem.lastChild,"dk-select-options-highlight"))for(s.removeClass(this.data.elem.lastChild,"dk-select-options-highlight"),i=0;i<l.length;i++)s.hasClass(l[i],"dk-option-highlight")&&(s.removeClass(l[i],"dk-option-highlight"),t=l[i]);(d=l.indexOf(t)+d)>l.length-1?d=l.length-1:d<0&&(d=0),this.data.select.options[d].disabled||(this.reset(!0),this.select(d),this._scrollTo(d));break;case r:if(!this.isOpen){e.preventDefault(),this.open();break}case o:case n:for(d=0;d<l.length;d++)s.hasClass(l[d],"dk-option-highlight")&&this.select(d);case h:this.isOpen&&(e.preventDefault(),this.close())}}_searchOptions(e){var t,i=this,a=String.fromCharCode(e.keyCode||e.which);void 0===this.data.searchString&&(this.data.searchString=""),i.data.searchTimeout&&clearTimeout(i.data.searchTimeout),i.data.searchTimeout=setTimeout(function(){i.data.searchString=""},1e3),this.data.searchString+=a,(t=this.search(this.data.searchString,this.data.settings.search)).length&&(s.hasClass(t[0],"dk-option-disabled")||this.selectOne(t[0]))}_scrollTo(e){var t,i,a=this.data.elem.lastChild;if(-1===e||"number"!=typeof e&&!e||!this.isOpen&&!this.multiple)return!1;"number"==typeof e&&(e=this.item(e)),(i=(t=s.position(e,a).top)-a.scrollTop)+e.offsetHeight>a.offsetHeight?(t+=e.offsetHeight,a.scrollTop=t-a.offsetHeight):i<0&&(a.scrollTop=t)}}return window.Dropkick=o,window.Dropkick.cache={},window.Dropkick.uid=0,o.build=function(e,t){var i,a,l,d=[],o={elem:null,options:[],selected:[]},n=function(e){var i,a,l,d,h=[];switch(e.nodeName){case"OPTION":i=s.create("li",{class:"dk-option ","data-value":e.value,text:e.text,innerHTML:e.innerHTML,role:"option","aria-selected":"false",id:t+"-"+(e.id||e.value.replace(" ","-"))}),s.addClass(i,e.className),e.disabled&&(s.addClass(i,"dk-option-disabled"),i.setAttribute("aria-disabled","true")),e.hidden&&(s.addClass(i,"dk-option-hidden"),i.setAttribute("aria-hidden","true")),e.selected&&(s.addClass(i,"dk-option-selected"),i.setAttribute("aria-selected","true"),o.selected.push(i)),o.options.push(this.appendChild(i));break;case"OPTGROUP":for(a=s.create("li",{class:"dk-optgroup"}),e.label&&a.appendChild(s.create("div",{class:"dk-optgroup-label",innerHTML:e.label})),l=s.create("ul",{class:"dk-optgroup-options"}),d=e.children.length;d--;h.unshift(e.children[d]));e.disabled&&(a.classList.add("dk-optgroup-disabled"),h.forEach(t=>{t.disabled=e.disabled})),h.forEach(n,l),this.appendChild(a).appendChild(l)}};for(o.elem=s.create("div",{class:"dk-select"+(e.multiple?"-multi":"")}),a=s.create("ul",{class:"dk-select-options",id:t+"-listbox",role:"listbox"}),e.disabled&&(s.addClass(o.elem,"dk-select-disabled"),o.elem.setAttribute("aria-disabled",!0)),o.elem.id=t+(e.id?"-"+e.id:""),s.addClass(o.elem,e.className),e.multiple?(o.elem.setAttribute("tabindex",e.getAttribute("tabindex")||"0"),a.setAttribute("aria-multiselectable","true")):(i=e.options[e.selectedIndex],o.elem.appendChild(s.create("div",{class:"dk-selected "+(i?i.className:""),tabindex:e.tabindex||0,innerHTML:i?i.text:"&nbsp;",id:t+"-combobox","aria-live":"assertive","aria-owns":a.id,role:"combobox"})),a.setAttribute("aria-expanded","false")),l=e.children.length;l--;d.unshift(e.children[l]));return d.forEach(n,o.elem.appendChild(a)),o},o.onDocClick=function(e){var t,i;let a=window.Dropkick;if(1!==e.target.nodeType)return!1;for(i in null!==(t=e.target.getAttribute("data-dkcacheid"))&&a.cache[t].focus(),a.cache)s.closest(e.target,a.cache[i].data.elem)||i===t||a.cache[i].disabled||a.cache[i].close()},t.fn.dropkick=function(){var e=Array.prototype.slice.call(arguments);return t(this).each(function(){e[0]&&"object"!=typeof e[0]?"string"==typeof e[0]&&o.prototype[e[0]].apply(new o(this),e.slice(1)):new o(this,e[0]||{})})},e.attach("intg.Dropkick",o)});
//# sourceMappingURL=sourcemaps/Dropkick.js.map
